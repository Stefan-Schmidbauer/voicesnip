name: Build Releases

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags
  workflow_dispatch:  # Allow manual trigger

jobs:
  # =============================================================================
  # Windows Builds
  # =============================================================================
  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - profile: basis
            name: VoiceSnip-Windows
            requirements: quickstrap/requirements_python_basis_windows.txt
            features: whisper,deepgram,faster-whisper-server
            pyinstaller_extras: ""
          - profile: cuda
            name: VoiceSnip-Windows-CUDA
            requirements: quickstrap/requirements_python_cuda_windows.txt
            features: whisper,deepgram,cuda,faster-whisper-server
            pyinstaller_extras: "--collect-all nvidia.cudnn --collect-all nvidia.cublas --collect-all nvidia_cublas_cu12 --collect-all nvidia_cudnn_cu12 --collect-all ctranslate2 --collect-binaries nvidia.cudnn --collect-binaries nvidia.cublas --collect-binaries nvidia_cublas_cu12 --collect-binaries nvidia_cudnn_cu12 --collect-binaries ctranslate2"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: ${{ matrix.requirements }}

      - name: Install dependencies (${{ matrix.profile }})
        run: |
          python -m pip install --upgrade pip
          pip install -r ${{ matrix.requirements }}
          pip install pyinstaller

      - name: Debug CUDA DLL locations
        if: matrix.profile == 'cuda'
        run: |
          echo "=== Finding cublas DLLs ==="
          python -c "import nvidia.cublas; print(nvidia.cublas.__path__)"
          Get-ChildItem -Path "$env:pythonLocation\Lib\site-packages\nvidia" -Recurse -Filter "*.dll" | Select-Object FullName
        continue-on-error: true

      - name: Collect CUDA DLLs
        run: |
          if ("${{ matrix.profile }}" -eq "cuda") {
            $nvidiaBin = "$env:pythonLocation\Lib\site-packages\nvidia"
            $dllArgs = ""
            Get-ChildItem -Path $nvidiaBin -Recurse -Filter "*.dll" | ForEach-Object {
              $dllArgs += "--add-binary `"$($_.FullName);.`" "
            }
            echo "CUDA_DLL_ARGS=$dllArgs" >> $env:GITHUB_ENV
          } else {
            echo "CUDA_DLL_ARGS=" >> $env:GITHUB_ENV
          }
        shell: pwsh

      - name: Build EXE with PyInstaller
        run: |
          $cmd = "pyinstaller --onefile --name VoiceSnip --icon=assets/icons/app/voicesnip.ico --add-data `"assets;assets`" --hidden-import pynput.keyboard._win32 --hidden-import pynput.mouse._win32 ${{ matrix.pyinstaller_extras }} $env:CUDA_DLL_ARGS main.py"
          Write-Host "Running: $cmd"
          Invoke-Expression $cmd
        shell: pwsh

      - name: Generate profile config
        run: |
          $content = @"
          [installation]
          profile = ${{ matrix.profile }}
          features = ${{ matrix.features }}
          install_date = $(Get-Date -Format o)
          "@
          # Remove leading spaces from each line (YAML indentation artifact)
          $content = ($content -split "`n" | ForEach-Object { $_.TrimStart() }) -join "`n"
          $content | Out-File -FilePath "voicesnip_profile.ini" -Encoding utf8 -NoNewline
        shell: pwsh

      - name: Prepare distribution package
        run: |
          mkdir dist-package
          copy dist\VoiceSnip.exe dist-package\
          copy voicesnip_profile.ini dist-package\
          copy .env.example dist-package\voicesnip.ini
          copy README.md dist-package\
          copy LICENSE dist-package\
          if exist voicesnip.png copy voicesnip.png dist-package\
        shell: cmd

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: dist-package/
          retention-days: 30

  # =============================================================================
  # Linux Builds (AppImage)
  # =============================================================================
  build-linux:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        include:
          - profile: basis
            name: VoiceSnip-Linux
            requirements: quickstrap/requirements_python_basis.txt
            features: whisper,deepgram,faster-whisper-server
            pyinstaller_extras: ""
          - profile: cuda
            name: VoiceSnip-Linux-CUDA
            requirements: quickstrap/requirements_python_cuda.txt
            features: whisper,deepgram,cuda,faster-whisper-server
            pyinstaller_extras: "--collect-all nvidia.cudnn --collect-all nvidia.cublas --collect-all nvidia_cublas_cu12 --collect-all nvidia_cudnn_cu12 --collect-all ctranslate2 --collect-binaries nvidia.cudnn --collect-binaries nvidia.cublas --collect-binaries nvidia_cublas_cu12 --collect-binaries nvidia_cudnn_cu12 --collect-binaries ctranslate2"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libportaudio2 \
            libxcb-xinerama0 \
            libxcb-cursor0 \
            fuse \
            libfuse2

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: ${{ matrix.requirements }}

      - name: Install dependencies (${{ matrix.profile }})
        run: |
          python -m pip install --upgrade pip
          pip install -r ${{ matrix.requirements }}
          pip install pyinstaller

      - name: Debug CUDA library locations
        if: matrix.profile == 'cuda'
        run: |
          echo "=== Finding cublas .so files ==="
          python -c "import nvidia.cublas; print(nvidia.cublas.__path__)" || true
          find $(python -c "import site; print(site.getsitepackages()[0])")/nvidia -name "*.so*" 2>/dev/null | head -20 || true
        continue-on-error: true

      - name: Collect CUDA shared libraries
        if: matrix.profile == 'cuda'
        run: |
          SITE_PACKAGES=$(python -c "import site; print(site.getsitepackages()[0])")
          NVIDIA_DIR="${SITE_PACKAGES}/nvidia"
          SO_ARGS=""
          for sofile in $(find "${NVIDIA_DIR}" -name "*.so*" -type f 2>/dev/null); do
            SO_ARGS="${SO_ARGS} --add-binary ${sofile}:."
          done
          echo "CUDA_SO_ARGS=${SO_ARGS}" >> $GITHUB_ENV
          echo "Found CUDA libraries: $(echo ${SO_ARGS} | wc -w) files"

      - name: Build binary with PyInstaller
        run: |
          pyinstaller --onefile --name VoiceSnip --add-data "assets:assets" --hidden-import pynput.keyboard._xorg --hidden-import pynput.mouse._xorg ${{ matrix.pyinstaller_extras }} ${CUDA_SO_ARGS} main.py

      - name: Download appimagetool
        run: |
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

      - name: Create AppDir structure
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          mkdir -p AppDir/usr/share/applications

          # Copy binary
          cp dist/VoiceSnip AppDir/usr/bin/
          chmod +x AppDir/usr/bin/VoiceSnip

          # Copy icon
          cp assets/icons/app/voicesnip_icon.png AppDir/usr/share/icons/hicolor/256x256/apps/voicesnip.png
          cp assets/icons/app/voicesnip_icon.png AppDir/voicesnip.png

          # Create .desktop file
          cat > AppDir/voicesnip.desktop << 'DESKTOP'
          [Desktop Entry]
          Type=Application
          Name=VoiceSnip
          Exec=VoiceSnip
          Icon=voicesnip
          Categories=AudioVideo;Audio;Utility;
          Comment=Voice-to-text transcription tool
          Terminal=false
          DESKTOP
          sed -i 's/^[[:space:]]*//' AppDir/voicesnip.desktop

          cp AppDir/voicesnip.desktop AppDir/usr/share/applications/

          # Create AppRun
          cat > AppDir/AppRun << 'APPRUN'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          export PATH="${HERE}/usr/bin:${PATH}"
          # Set LD_LIBRARY_PATH for CUDA libraries (if present)
          if [ -d "${HERE}/usr/lib" ]; then
            export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH}"
          fi
          exec "${HERE}/usr/bin/VoiceSnip" "$@"
          APPRUN
          sed -i 's/^[[:space:]]*//' AppDir/AppRun

          chmod +x AppDir/AppRun

      - name: Build AppImage
        run: |
          ARCH=x86_64 ./appimagetool-x86_64.AppImage --appimage-extract-and-run AppDir ${{ matrix.name }}.AppImage

      - name: Generate profile config
        run: |
          cat > voicesnip_profile.ini << EOF
          [installation]
          profile = ${{ matrix.profile }}
          features = ${{ matrix.features }}
          install_date = $(date -Iseconds)
          EOF
          # Remove leading spaces from each line (YAML indentation artifact)
          sed -i 's/^[[:space:]]*//' voicesnip_profile.ini

      - name: Prepare distribution package
        run: |
          mkdir dist-package
          cp ${{ matrix.name }}.AppImage dist-package/
          cp voicesnip_profile.ini dist-package/
          cp .env.example dist-package/voicesnip.ini
          cp README.md dist-package/
          cp LICENSE dist-package/
          [ -f voicesnip.png ] && cp voicesnip.png dist-package/ || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: dist-package/
          retention-days: 30

  # =============================================================================
  # Create Release
  # =============================================================================
  release:
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: |
          echo "Downloaded artifacts:"
          find artifacts -type f
          echo ""
          echo "Directory structure:"
          ls -la artifacts/

      - name: Create archives for release
        run: |
          cd artifacts
          for dir in */; do
            name="${dir%/}"
            if [[ "$name" == *"Windows"* ]]; then
              echo "Creating ZIP for $name"
              zip -9 -r "../${name}.zip" "$name"
            elif [[ "$name" == *"CUDA"* ]]; then
              echo "Creating tar.xz for $name (high compression for CUDA)"
              tar -cf - "$name" | xz -9 -T0 > "../${name}.tar.xz"
            else
              echo "Creating tar.gz for $name"
              tar -czvf "../${name}.tar.gz" "$name"
            fi
          done
          cd ..
          echo ""
          echo "Created archives:"
          ls -la *.zip *.tar.gz *.tar.xz 2>/dev/null || true

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            *.zip
            *.tar.gz
            *.tar.xz
          generate_release_notes: true
          body: |
            ## Downloads

            ### Windows
            | File | Description |
            |------|-------------|
            | `VoiceSnip-Windows.zip` | CPU-only (Deepgram Cloud + Whisper CPU) |
            | `VoiceSnip-Windows-CUDA.zip` | GPU-accelerated (requires NVIDIA GPU + CUDA) |

            ### Linux
            | File | Description |
            |------|-------------|
            | `VoiceSnip-Linux.tar.gz` | CPU-only AppImage (Deepgram Cloud + Whisper CPU) |
            | `VoiceSnip-Linux-CUDA.tar.xz` | GPU-accelerated AppImage (requires NVIDIA GPU + CUDA) |

            ---

            ## Installation

            ### Windows
            1. Download the appropriate ZIP for your system
            2. Extract to a folder of your choice
            3. Edit `voicesnip.ini` and add your API keys (optional, only for Deepgram)
            4. Run `VoiceSnip.exe`

            > **Note:** Windows may show an "Unknown publisher" warning. Click "More info" â†’ "Run anyway".

            ### Linux
            1. Download the appropriate archive for your system
            2. Extract: `tar -xf VoiceSnip-Linux*.tar.*` (works for both .tar.gz and .tar.xz)
            3. Edit `voicesnip.ini` and add your API keys (optional, only for Deepgram)
            4. Make executable: `chmod +x *.AppImage`
            5. Run: `./VoiceSnip-Linux*.AppImage`

            ---

            ## Which version should I choose?

            **CPU versions** (`VoiceSnip-Windows.zip` / `VoiceSnip-Linux.tar.gz`):
            - Works on any PC
            - Uses CPU for local Whisper transcription
            - Smaller download size

            **CUDA versions** (`VoiceSnip-Windows-CUDA.zip` / `VoiceSnip-Linux-CUDA.tar.xz`):
            - Requires NVIDIA GPU with CUDA installed
            - Much faster local transcription
            - Larger download size
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
